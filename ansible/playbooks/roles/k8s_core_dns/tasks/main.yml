---
- name: Create CoreDNS ConfigMap with clean upstream DNS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: coredns-custom-config
        namespace: "{{ coredns_namespace }}"
      data:
        Corefile: |
          .:53 {
            errors
            health
            ready
            kubernetes cluster.local in-addr.arpa ip6.arpa {
            pods insecure
            fallthrough in-addr.arpa ip6.arpa
            }
            prometheus :9153
            # FIX: Use DNS-over-TLS on port 853 to bypass ISP interception
            forward . tls://1.1.1.1 tls://1.0.0.1 {
            tls_servername cloudflare-dns.com
            }
            cache 30
            loop
            reload
            loadbalance
            }

- name: Deploy Custom CoreDNS
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: coredns-custom
        namespace: "{{ coredns_namespace }}"
        labels:
          k8s-app: kube-dns-custom
      spec:
        replicas: 2
        selector:
          matchLabels:
            k8s-app: kube-dns-custom
        template:
          metadata:
            labels:
              k8s-app: kube-dns-custom
          spec:
            serviceAccountName: coredns-custom
            containers:
              - name: coredns
                image: coredns/coredns:1.11.1
                args: [ "-conf", "/etc/coredns/Corefile" ]
                volumeMounts:
                  - name: config-volume
                    mountPath: /etc/coredns
                    readOnly: true
                ports:
                  - containerPort: 53
                    name: dns
                    protocol: UDP
                  - containerPort: 53
                    name: dns-tcp
                    protocol: TCP
                  - containerPort: 9153
                    name: metrics
                    protocol: TCP
            volumes:
              - name: config-volume
                configMap:
                  name: coredns-custom-config

- name: Create kube-dns Service with fixed ClusterIP
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: kube-dns
        namespace: "{{ coredns_namespace }}"
        annotations:
          prometheus.io/port: "9153"
          prometheus.io/scrape: "true"
      spec:
        selector:
          k8s-app: kube-dns-custom
        clusterIP: "{{ dns_cluster_ip }}"
        ports:
          - name: dns
            port: 53
            protocol: UDP
          - name: dns-tcp
            port: 53
            protocol: TCP
          - name: metrics
            port: 9153
            protocol: TCP

- name: Create CoreDNS ServiceAccount
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: coredns-custom
        namespace: "{{ coredns_namespace }}"

- name: Create CoreDNS ClusterRole
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: coredns-custom
      rules:
        - apiGroups: [""]
          resources: ["endpoints", "services", "pods", "namespaces"]
          verbs: ["list", "watch"]
        - apiGroups: ["discovery.k8s.io"]
          resources: ["endpointslices"]
          verbs: ["list", "watch"]

- name: Create CoreDNS ClusterRoleBinding
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: coredns-custom
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: coredns-custom
      subjects:
        - kind: ServiceAccount
          name: coredns-custom
          namespace: "{{ coredns_namespace }}"
